# 流量控制

---

## 简介

Linux 流量控制，我们只能对发送的数据进行流量整形和流量控制，即：控发不控收，换句话说，我们无法直接控制谁给我们发包（有点类似于邮箱，即，无法控制谁向我们发邮件）。

## 两种流量控制的算法

### 无类算法 

#### 用于树叶级无分支的队列

PFIFO_FAST（pfifo_fast）
 这个队列中有三个所谓的频道（band0，band1，band2），如果频道0有数据包等待发送，频道1就不会再被处理，频道1和频道2之间的关系也是如此。

pfifo_fast 只起到调度的作用，对数据流量不进行控制。并且 pfifo_fast 是系统默认的队列类型， 可以使用 ip 命令来查看当前的网络队列设置：

```
>>> ip link list
1: lo: <LOOPBACK,UP> mtu 16436 qdisc noqueue
 link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
2: eth0: <BROADCAST,MULTICAST,UP> mtu 1500 qdisc tbf qlen 1000
 link/ether 00:40:ca:66:3d:d2 brd ff:ff:ff:ff:ff:ff
```

#### SFQ（ Stochastic Fairness Queueing）

SFQ 是公平队列算法家族中的一个简单实现，它没有其他方法那么精确，它在实现高度公平的同时，需要的计算量很小，SFQ 主要针对一个 TCP 会话或者 UDP 流，流量被分成相当多数据量的 FIFO 队列中，每个队列对应一个会话，数据按照简单轮询的方式发送，每个会话都按顺序得到发送机会。


### 分类算法
分类算法主要作用是可以对多种数据流区别对待 . 一旦数据包进入一个分类的队列规定 , 它就得被送到某一个类中分类 , 对数据包进行分类的工具是过滤器 . 

#### CBQ（The famous CBQ qdisc）

CBQ 的工作机制是确定链路的闲置时间足够长，以达到降低链路实际带宽的目的，为此，它要计算两个数据包的平均发送间隔。

#### HTB（Hierarchical Token Bucket）

相较 CBQ 而言，HTB 的配置简单，易懂。它的工作原理和相关配置同于 TBF。

#### PRIO qdisc（The PRIO qdisc）


## 过滤器(Filter)

过滤器是对数据包进行分类的工具，过滤器用于把数据包分类并放入相应的子队列，这些过滤器在分类的队列规定内部被调用。
常用的过滤器：

### FW 过滤器
基于数据包上的标记进行过滤。通常通过 iptables 进行打标记。

### U32 过滤器
基于 IP 报文内的数据进行过滤。

### ROUTE 过滤器
基于路由决策进行过滤。

### PRIO 过滤器
基于策略（class）中的 PRIO 进行过滤。

## CLASS(策略)
class 用来表示控制策略，很显然，很多时候，我们很可能要对不通的 IP 实行不同的流量控制策略，这时候我们就要用不同的 class 来表示不同的控制策略了。
