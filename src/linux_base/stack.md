# IPtables 和 Netfilter

----


## Netfilter

  为了说明这个问题，首先看一个网络通信的基本模型：
 
 ![conn][1]

  在数据的发送过程中，从上至下依次是`加头`的过程，每到达一层数据就被会加上
该层的头部；与此同时，接受数据方就是个`剥头`的过程，从网卡收上包来之后，
在往协议栈的上层传递过程中依次剥去每层的头部，最终到达用户那儿的就是裸数据了。

那么，`栈`模式底层机制基本就是像下面这个样子：

 ![stack][2] 


对于收到的每个数据包，都从`A`点进来，经过路由判决，
如果是发送给本机的就经过`B`点，然后往协议栈的上层继续传递；
否则，如果该数据包的目的地是不本机，那么就经过`C`点，
然后顺着`E`点将该包转发出去。
对于发送的每个数据包，首先也有一个路由判决，以确定该包是从哪个接口出去，
然后经过`D`点，最后也是顺着`E`点将该包发送出去。
协议栈那五个关键点A，B，C，D 和 E 就是我们 Netfilter 大展拳脚的地方了。


Netfilter 是 Linux 2.4.x 引入的一个子系统，它作为一个通用的、抽象的框架，
提供一整套的 hook 函数的管理机制，使得诸如数据包过滤、网络地址转换(NAT)
和基于协议类型的连接跟踪成为了可能。Netfilter 在内核中位置如下图所示：

  ![netfilter][3]

这幅图，很直观的反应了用户空间的 iptables 和内核空间的基于 Netfilter 的 
ip_tables 模块之间的关系和其通讯方式，以及 Netfilter 在这其中所扮演的角色。

回到前面讨论的关于协议栈那五个关键点`ABCDE`上来。Netfilter 在`netfilter_ipv4.h`
中将这个五个点重新命了个名，如下图所示，意思我就不再解释了，猫叫咪咪而已：


  ![netfilter][4]


在每个关键点上，有很多已经按照优先级预先注册了的回调函数(有些人喜欢把这些函数称为`钩子函数`，说的是同一个东西)
埋伏在这些关键点，形成了一条链。对于每个到来的数据包会依次被那些回调函数`调戏`一番再视情况是将其放行，丢弃还是如何。
但是无论如何，这些回调函数最后必须向 Netfilter 报告一下该数据包的死活情况，
因为毕竟每个数据包都是 Netfilter 从人家协议栈那儿借调过来给处理的。
每个钩子函数最后必须向 Netfilter 框架返回下列几个值其中之一：

*  NF_ACCEPT 继续正常传输数据报。这个返回值告诉 Netfilter：到目前为止，
该数据包还是被接受的并且该数据包应当被递交到网络协议栈的下一个阶段。
*  NF_DROP 丢弃该数据报，不再传输。
*  NF_STOLEN 模块接管该数据报，告诉 Netfilter `忘掉`该数据报。
该回调函数将从此开始对数据包的处理，并且 Netfilter 应当放弃对该数据包做任何的
处理。但是，这并不意味着该数据包的资源已经被释放。这个数据包以及它独自的 sk_buff 数据结构仍然有效，只是回调函数从 Netfilter 获取了该数据包的所有权。
*  NF_QUEUE 对该数据报进行排队(通常用于将数据报给用户空间的进程进行处理)
*  NF_REPEAT 再次调用该回调函数，应当谨慎使用这个值，以免造成死循环。


## IPtables
IPtables 是 Linux 平台下的内核态防火墙。所谓内核态防火墙，即表示当网卡接收到数
据包后，通过 IRQ（Interrupt Request）通知驱动程序，操作系统内核通过驱动程序将
数据包从网卡的缓存拷贝到内核态内存，此时内核态防火墙处理，并决定数据包的下一步的走向。和用户态防火墙相比，内核态防火墙的好处是可靠性高，效率高。这里需要特别指出的是，IPtables 只是用户态的 Linux 防火墙的管理工具，位于/sbin/iptables。
真正干活的是在 Linux 内核中实现包过滤的 netfilter。
Netfilter 在内核中规定了五个规则链（也是五个钩子函数），
任何一个数据包只要经过本机一定经过这五条其中的一条链。

这五条链分别是：

 * PREROUTING (路由前)
 * INPUT (数据包流入口)
 * FORWARD (转发)
 * OUTPUT(数据包出口)              
 * POSTROUTING（路由后）

流程图如下：

 ![iptables][5]


参考文档：

* [洞悉 Linux下 的 Netfilter & iptables](http://blog.chinaunix.net/uid-23069658-id-3160506.html)

[1]: ../../images/linux_base/conn.png
[2]: ../../images/linux_base/stack.png
[3]: ../../images/linux_base/netfilter.png
[4]: ../../images/linux_base/netfilter2.png
[5]: ../../images/linux_base/iptables.png
