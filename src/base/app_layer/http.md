# HTTP

----

## 简介

HTTP 协议是互联网的基础协议，也是网页开发的必备知识，最新版本 HTTP/2 更是让它
成为技术热点。


## HTTP/0.9

HTTP 是基于 TCP/IP 协议的应用层协议。它不涉及数据包（packet）传输，主要规定了
客户端和服务器之间的通信格式，默认使用 80 端口。
最早版本是 1991 年发布的 0.9 版。该版本极其简单，只有一个命令 `GET`。

    GET /index.html

上面命令表示，TCP 连接（connection）建立后，客户端向服务器请求（request）网页
 index.html。
协议规定，服务器只能回应 HTML 格式的字符串，不能回应别的格式。

    <html>
      <body>Hello World</body>
    </html>

服务器发送完毕，就关闭 TCP 连接。

## HTTP/1.0

1996 年 5 月，HTTP/1.0 版本发布，内容大大增加。
首先，任何格式的内容都可以发送。这使得互联网不仅可以传输文字，还能传输图像、视频、二进制文件。这为互联网的大发展奠定了基础。
其次，除了 GET 命令，还引入了 POST 命令和 HEAD 命令，
丰富了浏览器与服务器的互动手段。
再次，HTTP 请求和回应的格式也变了。除了数据部分，每次通信都必须包括头信息
（HTTP header），用来描述一些元数据。
其他的新增功能还包括状态码（status code）、多字符集支持、
多部分发送（multi-part type）、权限（authorization）、缓存（cache）、内容编码（content encoding）等。

下面是一个 1.0 版的 HTTP 请求的例子。

    GET / HTTP/1.0
    User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5)
    Accept: */*


可以看到，这个格式与 0.9 版有很大变化。
第一行是请求命令，必须在尾部添加协议版本（HTTP/1.0）。后面就是多行头信息，描述客户端的情况。


服务器的回应如下。

    HTTP/1.0 200 OK 
    Content-Type: text/plain
    Content-Length: 137582
    Expires: Thu, 05 Dec 1997 16:00:00 GMT
    Last-Modified: Wed, 5 August 1996 15:55:28 GMT
    Server: Apache 0.84
    
    <html>
      <body>Hello World</body>
    </html>


HTTP/1.0 版的主要缺点是，每个 TCP 连接只能发送一个请求。
发送数据完毕，连接就关闭，如果还要请求其他资源，就必须再新建一个连接。
TCP 连接的新建成本很高，因为需要客户端和服务器三次握手，并且开始时发送速率较慢（slow start）。
所以，HTTP 1.0 版本的性能比较差。随着网页加载的外部资源越来越多，
这个问题就愈发突出了。
为了解决这个问题，有些浏览器在请求时，用了一个非标准的 Connection 字段。

    Connection: keep-alive

这个字段要求服务器不要关闭TCP连接，以便其他请求复用。服务器同样回应这个字段。

    Connection: keep-alive

一个可以复用的 TCP 连接就建立了，直到客户端或服务器主动关闭连接。
但是，这不是标准字段，不同实现的行为可能不一致，因此不是根本的解决办法。

## HTTP/1.1

1997年1月，HTTP/1.1 版本发布，只比 1.0 版本晚了半年。它进一步完善了 HTTP 协议
，一直到现在还是最流行的版本。

1.1 版的最大变化，就是引入了持久连接（persistent connection），即 TCP 
连接默认不关闭，可以被多个请求复用，不用声明 `Connection: keep-alive`。

客户端和服务器发现对方一段时间没有活动，就可以主动关闭连接。
不过，规范的做法是，客户端在最后一个请求时，发送 `Connection: close`，
明确要求服务器关闭 TCP 连接。

    Connection: close


## HTTP/2

2015年，HTTP/2 发布。它不叫 HTTP/2.0，是因为标准委员会不打算再发布子版本了，下一个新版本将是 HTTP/3。

HTTP/2 的特点是：
 * 二进制协议：HTTP/2 则是一个彻底的二进制协议，头信息和数据体都是二进制，并且统称为"帧"（frame）：头信息帧和数据帧。
 * 多工：HTTP/2 复用TCP连接，在一个连接里，客户端和浏览器都可以同时发送多个请求或回应，
而且不用按照顺序一一对应，这样就避免了"队头堵塞"。
 * 数据流：HTTP/2 将每个请求或回应的所有数据包，称为一个数据流（stream）。
每个数据流都有一个独一无二的编号。
数据包发送的时候，都必须标记数据流ID，用来区分它属于哪个数据流。
 * 头信息压缩：HTTP/2 对这一点做了优化，引入了头信息压缩机制（header compression）。
一方面，头信息使用 gzip 或 compress 压缩后再发送；
另一方面，客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，
生成一个索引号，以后就不发送同样字段了，只发送索引号，这样就提高速度了。
 * 服务器推送：HTTP/2 允许服务器未经请求，主动向客户端发送资源，这叫做服务器推送（server push）。

